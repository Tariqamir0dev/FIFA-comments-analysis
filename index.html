<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير تحليل آراء العملاء - عطارة فيفا الحمدانية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', 'Arial', 'Tahoma', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .report-container {
            max-width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: visible;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* أنماط التحميل */
        .report-container.downloading {
            width: 210mm !important;
            max-width: 210mm !important;
            height: auto !important;
            overflow: visible !important;
            position: static !important;
            transform: none !important;
        }

        .header {
            background: linear-gradient(135deg, #665549 0%, #a9a569 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/><circle cx="30" cy="30" r="15" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/><circle cx="70" cy="70" r="20" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1.5"/></svg>') repeat;
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .header-author {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .report-date {
            background: rgba(255,255,255,0.2);
            padding: 6px 15px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .content {
            padding: 20px 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            position: relative;
            flex-shrink: 0;
        }

        .section h2 {
            color: #665549;
            font-size: 1.3em;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #a9a569;
            position: relative;
        }

        .section h2::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -3px;
            width: 50px;
            height: 3px;
            background: #665549;
            border-radius: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .stat-card {
            color: white;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card.total {
            background: linear-gradient(135deg, #665549 0%, #a9a569 100%);
        }

        .stat-card.positive {
            background: linear-gradient(135deg, #a9a569 0%, #c4c48a 100%);
        }

        .stat-card.negative {
            background: linear-gradient(135deg, #665549 0%, #8b7355 100%);
        }

        .stat-card.satisfaction {
            background: linear-gradient(135deg, #a9a569 0%, #665549 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .analysis-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            border-left: 3px solid #a9a569;
        }

        .analysis-card.negative {
            border-left-color: #665549;
        }

        .analysis-card h3 {
            color: #665549;
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
        }

        .positive-icon {
            background: #a9a569;
        }

        .negative-icon {
            background: #665549;
        }

        .improvement-icon {
            background: #8b7355;
        }

        .analysis-list {
            list-style: none;
        }

        .analysis-list li {
            margin: 4px 0;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-right: 3px solid #a9a569;
            font-size: 0.8em;
            line-height: 1.3;
        }

        .rating-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rating-container {
            text-align: center;
            margin: 10px 0;
            padding: 15px;
            background: linear-gradient(135deg, #a9a569 0%, #c4c48a 50%, #c4c48a 100%);
            border-radius: 12px;
            position: relative;
        }


        .rating-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #665549 0%, #8b7355 36%, #a9a569 72%, #a9a569 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
        }

        .rating-inner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .rating-score {
            font-size: 2em;
            font-weight: bold;
            color: #665549;
            line-height: 1;
        }

        .rating-total {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .rating-description {
            font-size: 1em;
            color: #665549;
            font-weight: bold;
            margin-top: 8px;
        }

        .recommendations {
            background: linear-gradient(135deg, #665549 0%, #a9a569 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .recommendations h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .recommendation-item {
            background: rgba(255,255,255,0.15);
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .recommendation-item h4 {
            font-size: 1em;
            margin-bottom: 6px;
            color: #fff;
        }

        .footer {
            background: #665549;
            color: white;
            text-align: center;
            padding: 15px;
            margin-top: 10px;
            flex-shrink: 0;
        }

        .download-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #a9a569;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(169, 165, 105, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .download-btn:hover {
            background: #665549;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 85, 73, 0.4);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .stat-label {
                font-size: 0.9em;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .rating-section {
                gap: 20px;
            }
            
            .header-author {
                position: static;
                margin-bottom: 15px;
                text-align: center;
                background: rgba(255,255,255,0.15);
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .download-btn {
                display: none;
            }
            
            .report-container {
                box-shadow: none;
                border-radius: 0;
                max-width: none;
                margin: 0;
                height: auto !important;
                min-height: auto !important;
                overflow: visible !important;
            }
            
            .content {
                height: auto !important;
                overflow: visible !important;
            }
            
            .section {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        .highlight-box {
            background: linear-gradient(135deg, #a9a569 0%, #c4c48a 100%);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #665549;
        }

        .employee-highlight {
            background: linear-gradient(135deg, #a9a569 0%, #c4c48a 100%);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            text-align: center;
            border: 2px solid #665549;
        }

        .employee-highlight h4 {
            color: #665549;
            font-size: 1em;
            margin-bottom: 6px;
        }

        .star-rating {
            color: #665549;
            font-size: 1em;
            margin: 6px 0;
        }
    </style>
</head>
<body>
    <button class="download-btn" onclick="downloadAsImage()">📸 تحميل كصورة</button>
    
    <div class="report-container" id="report">
        <div class="header">
            <div class="header-author">إعداد: م / طارق عامر</div>
            <div class="header-content">
                <h1>📊 تقرير تحليل آراء العملاء</h1>
                <div class="subtitle">عطارة فيفا - فرع المدينة المنورة</div>
                <div class="report-date">تاريخ التقرير: سبتمبر 2025</div>
            </div>
        </div>

        <div class="content">
            <!-- إحصائيات عامة -->
            <div class="section">
                <h2>📈 الإحصائيات العامة</h2>
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="stat-number">27</div>
                        <div class="stat-label">إجمالي التعليقات</div>
                    </div>
                    <div class="stat-card positive">
                        <div class="stat-number">26</div>
                        <div class="stat-label">التعليقات الإيجابية</div>
                    </div>
                    <div class="stat-card negative">
                        <div class="stat-number">1</div>
                        <div class="stat-label">التعليقات السلبية</div>
                    </div>
                    <div class="stat-card satisfaction">
                        <div class="stat-number">96%</div>
                        <div class="stat-label">معدل الرضا</div>
                    </div>
                </div>
            </div>

            <!-- التقييم الإجمالي -->
            <div class="section">
                <h2>🎯 التقييم الإجمالي للفرع</h2>
                <div class="rating-section">
                <div class="rating-container">
                    <div class="rating-circle">
                        <div class="rating-inner">
                            <div class="rating-score">9.6</div>
                            <div class="rating-total">/10</div>
                        </div>
                    </div>
                    <div class="rating-description">تقييم ممتاز جداً - من أفضل الفروع</div>
                    <div class="star-rating">★★★★★</div>
                    </div>
                    
                </div>
            </div>

            <!-- تحليل الإيجابيات والسلبيات -->
            <div class="section">
                <h2>⚖️ تحليل نقاط القوة والضعف</h2>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3><span class="icon positive-icon">+</span>نقاط القوة</h3>
                        <ul class="analysis-list">
                            <li><strong>جودة المنتجات المتنوعة:</strong> تمور وبهارات ومكسرات ومعاميل ومنتجات تجميلية</li>
                            <li><strong>خدمة العملاء المتميزة:</strong> موظفين متميزين في التعامل مع العملاء</li>
                            <li><strong>النظافة والترتيب:</strong> معايير عالية في المحل</li>
                            <li><strong>الأسعار والعروض:</strong> أسعار جيدة نسبياً مع عروض مغرية</li>
                            <li><strong>موظفون متميزون:</strong> علي الحريبي وسامي ويونس والبراء</li>
                        </ul>
                    </div>
                    
                    <div class="analysis-card negative">
                        <h3><span class="icon negative-icon">-</span>نقاط تحتاج تحسين</h3>
                        <ul class="analysis-list">
                            <li><strong>طريقة عرض الأسعار:</strong> لبس في الضرائب والخصومات يحتاج توضيح أكثر</li>
                        </ul>
                    </div>
                </div>

                <!-- تسليط الضوء على الموظف المتميز -->
                <div class="employee-highlight">
                    <h4>🏆 الموظفون المتميزون</h4>
                    <p><strong>علي الحريبي - سامي - يونس - البراء</strong></p>
                    <p>علي الحريبي أشاد به عدة عملاء لخدمته الراقية وأخلاقه العالية، وسامي محبوب ولبق، ويونس والبراء تميزوا بخدمتهم الراقية</p>
                    <div class="star-rating">★★★★★</div>
                </div>
            </div>

            <!-- التوصيات والتحسينات -->
            <div class="recommendations">
                <h3>🎯 خطة التحسين المقترحة</h3>
                
                <div class="recommendation-item">
                    <h4>1️⃣ توضيح الأسعار والخصومات</h4>
                    <p>توضيح شامل للضرائب والخصومات على الفواتير لتجنب اللبس</p>
                </div>

                <div class="recommendation-item">
                    <h4>2️⃣ التواصل مع العملاء</h4>
                    <p>وضع لافتة أو توضيح إلكتروني يشرح طريقة احتساب الخصم والضريبة</p>
                </div>

                <div class="recommendation-item">
                    <h4>3️⃣ تدريب الموظفين</h4>
                    <p>الاستمرار في تدريب الموظفين على أسلوب التعامل الودي والاحترافي</p>
                </div>

                <div class="recommendation-item">
                    <h4>4️⃣ المحافظة على التميز</h4>
                    <p>الاستمرار في نفس مستوى الأداء المتميز الحالي</p>
                </div>
            </div>

            <!-- النتيجة النهائية -->
            <div class="highlight-box">
                <h3 style="color: #e91e63; text-align: center; margin-bottom: 15px;">📋 الخلاصة النهائية</h3>
                <p style="text-align: center; font-size: 1.1em; line-height: 1.8;">
                    <strong>عطارة فيفا - فرع المدينة المنورة</strong> تحصل على تقييم <strong>9.6/10</strong><br>
                    الفرع يُعد من أفضل فروع عطارة فيفا مع تقييمات إيجابية جداً (96%) على جودة المنتجات والخدمة والنظافة.<br>
                    الملاحظة الوحيدة الجديرة بالاهتمام هي ضرورة توضيح أسعار المنتجات والضرائب لتجنب سوء الفهم.
                </p>
            </div>
        </div>

        <div class="footer">
            <p>تم إعداد هذا التقرير بناءً على تحليل 27 تعليق من العملاء خلال الفترة من أغسطس إلى سبتمبر 2025</p>
            <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                📧 لمزيد من التفاصيل: 0535858440 | 🌐 إدارة عطارة فيفا
            </p>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // دالة لضمان تحميل الخطوط
        async function ensureFontsLoaded() {
            try {
                await document.fonts.ready;
                console.log('الخطوط جاهزة');
                
                // انتظار إضافي للتأكد
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // التحقق من تحميل خط Cairo
                const testElement = document.createElement('div');
                testElement.style.fontFamily = 'Cairo, Arial, sans-serif';
                testElement.style.position = 'absolute';
                testElement.style.left = '-9999px';
                testElement.textContent = 'Test';
                document.body.appendChild(testElement);
                
                const computedStyle = window.getComputedStyle(testElement);
                const fontFamily = computedStyle.fontFamily;
                
                document.body.removeChild(testElement);
                
                console.log('خط محمل:', fontFamily);
                return true;
            } catch (error) {
                console.error('خطأ في تحميل الخطوط:', error);
                return false;
            }
        }
        
        // دالة لضمان تحميل جميع الموارد
        async function ensureResourcesLoaded() {
            const promises = [];
            
            // انتظار تحميل الخطوط
            promises.push(ensureFontsLoaded());
            
            // انتظار تحميل الصور
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                if (!img.complete) {
                    promises.push(new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    }));
                }
            });
            
            // انتظار تحميل CSS
            promises.push(new Promise(resolve => {
                if (document.readyState === 'complete') {
                    resolve();
                } else {
                    window.addEventListener('load', resolve);
                }
            }));
            
            await Promise.all(promises);
            console.log('جميع الموارد محملة');
        }
        
        // دالة للتحقق من صحة العنصر
        function validateElement(element) {
            if (!element) {
                throw new Error('العنصر غير موجود');
            }
            
            const rect = element.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                throw new Error('العنصر له أبعاد صفر');
            }
            
            const computedStyle = window.getComputedStyle(element);
            if (computedStyle.display === 'none') {
                throw new Error('العنصر مخفي');
            }
            
            if (computedStyle.visibility === 'hidden') {
                throw new Error('العنصر غير مرئي');
            }
            
            console.log('العنصر صالح للتحميل');
            return true;
        }
        async function downloadAsImage() {
            try {
                console.log('بدء عملية التحميل...');
                
            const element = document.getElementById('report');
                if (!element) {
                    alert('خطأ: لم يتم العثور على العنصر');
                    return;
                }
                
                // التحقق من صحة العنصر
                validateElement(element);
                
                // إظهار مؤشر التحميل
                const loadingBtn = document.querySelector('.download-btn');
                const originalText = loadingBtn.textContent;
                loadingBtn.textContent = '⏳ جاري التحميل...';
                loadingBtn.disabled = true;
                
                // حفظ الأنماط الأصلية
                const originalStyles = {
                    height: element.style.height,
                    minHeight: element.style.minHeight,
                    maxHeight: element.style.maxHeight,
                    overflow: element.style.overflow,
                    width: element.style.width,
                    maxWidth: element.style.maxWidth,
                    position: element.style.position,
                    transform: element.style.transform
                };
                
                // تطبيق أنماط التحميل
                element.classList.add('downloading');
                element.style.height = 'auto';
                element.style.minHeight = 'auto';
                element.style.maxHeight = 'none';
                element.style.overflow = 'visible';
                element.style.width = '210mm';
                element.style.maxWidth = '210mm';
                element.style.position = 'static';
                element.style.transform = 'none';
                
                // انتظار تحميل جميع الموارد
                await ensureResourcesLoaded();
                
                // انتظار إضافي للتأكد من التحميل
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // حساب الأبعاد الفعلية
                const rect = element.getBoundingClientRect();
                const scrollWidth = element.scrollWidth;
                const scrollHeight = element.scrollHeight;
                
                console.log('أبعاد العنصر:', {
                    width: rect.width,
                    height: rect.height,
                    scrollWidth: scrollWidth,
                    scrollHeight: scrollHeight
                });
                
                // محاولة التحميل مع معاملات مختلفة
                let canvas;
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts) {
                    try {
                        console.log(`محاولة ${attempts + 1} من ${maxAttempts}`);
                        
                        const options = {
                            scale: attempts === 0 ? 1.2 : 1,
                useCORS: true,
                backgroundColor: '#ffffff',
                            allowTaint: true,
                            foreignObjectRendering: true,
                            logging: true,
                            removeContainer: false,
                scrollX: 0,
                            scrollY: 0,
                            width: 794, // A4 width in pixels
                            height: Math.max(scrollHeight, 1123), // A4 height or content height
                            windowWidth: 794,
                            windowHeight: Math.max(scrollHeight, 1123),
                            onclone: function(clonedDoc) {
                                console.log('معالجة النسخة المستنسخة...');
                                
                                // إزالة قيود الارتفاع من العنصر الرئيسي
                                const clonedElement = clonedDoc.getElementById('report');
                                if (clonedElement) {
                                    clonedElement.style.height = 'auto';
                                    clonedElement.style.minHeight = 'auto';
                                    clonedElement.style.maxHeight = 'none';
                                    clonedElement.style.overflow = 'visible';
                                    clonedElement.style.width = '210mm';
                                    clonedElement.style.maxWidth = '210mm';
                                    clonedElement.style.position = 'static';
                                    clonedElement.style.transform = 'none';
                                }
                                
                                // إزالة قيود الارتفاع من جميع العناصر
                                const allElements = clonedDoc.querySelectorAll('*');
                                allElements.forEach(el => {
                                    el.style.height = 'auto';
                                    el.style.minHeight = 'auto';
                                    el.style.maxHeight = 'none';
                                    el.style.overflow = 'visible';
                                    el.style.position = 'static';
                                    el.style.transform = 'none';
                                });
                                
                                // التأكد من أن الخطوط محملة
                                const style = clonedDoc.createElement('style');
                                style.textContent = `
                                    * {
                                        font-family: 'Cairo', Arial, sans-serif !important;
                                    }
                                    .report-container {
                                        width: 210mm !important;
                                        max-width: 210mm !important;
                                        height: auto !important;
                                        overflow: visible !important;
                                    }
                                `;
                                clonedDoc.head.appendChild(style);
                                
                                console.log('تم معالجة النسخة المستنسخة');
                            }
                        };
                        
                        canvas = await html2canvas(element, options);
                        console.log('تم إنشاء Canvas بنجاح');
                        break;
                        
                    } catch (error) {
                        console.error(`فشلت المحاولة ${attempts + 1}:`, error);
                        attempts++;
                        if (attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                if (!canvas) {
                    throw new Error('فشل في إنشاء Canvas بعد جميع المحاولات');
                }
                
                // التحقق من أن Canvas يحتوي على محتوى
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Canvas فارغ أو أبعاده صفر');
                }
                
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                let hasContent = false;
                let nonWhitePixels = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (r !== 255 || g !== 255 || b !== 255) {
                        hasContent = true;
                        nonWhitePixels++;
                    }
                }
                
                console.log(`عدد البكسلات غير البيضاء: ${nonWhitePixels}`);
                
                if (!hasContent || nonWhitePixels < 100) {
                    throw new Error(`Canvas فارغ أو يحتوي على محتوى قليل جداً - البكسلات: ${nonWhitePixels}`);
                }
                
                console.log('Canvas يحتوي على محتوى، جاري التحميل...');
                
                // إنشاء الرابط وتحميل الصورة
            const link = document.createElement('a');
            link.download = 'تقرير_عطارة_فيفا_الحمدانية.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
                
                console.log('تم التحميل بنجاح');
                
                // استعادة الأنماط الأصلية
                element.classList.remove('downloading');
                element.style.height = originalStyles.height;
                element.style.minHeight = originalStyles.minHeight;
                element.style.maxHeight = originalStyles.maxHeight;
                element.style.overflow = originalStyles.overflow;
                element.style.width = originalStyles.width;
                element.style.maxWidth = originalStyles.maxWidth;
                element.style.position = originalStyles.position;
                element.style.transform = originalStyles.transform;
                
                // استعادة النص الأصلي للزر
                loadingBtn.textContent = originalText;
                loadingBtn.disabled = false;
                
            } catch (error) {
                console.error('خطأ في التحميل:', error);
                alert('حدث خطأ في التحميل: ' + error.message);
                
                // استعادة الأنماط الأصلية في حالة الخطأ
                const element = document.getElementById('report');
                if (element && originalStyles) {
                    element.classList.remove('downloading');
                    element.style.height = originalStyles.height;
                    element.style.minHeight = originalStyles.minHeight;
                    element.style.maxHeight = originalStyles.maxHeight;
                    element.style.overflow = originalStyles.overflow;
                    element.style.width = originalStyles.width;
                    element.style.maxWidth = originalStyles.maxWidth;
                    element.style.position = originalStyles.position;
                    element.style.transform = originalStyles.transform;
                }
                
                // استعادة النص الأصلي للزر
                const loadingBtn = document.querySelector('.download-btn');
                loadingBtn.textContent = '📸 تحميل كصورة';
                loadingBtn.disabled = false;
            }
        }

        // تحسين النص للطباعة
        window.addEventListener('beforeprint', function() {
            document.body.style.background = 'white';
        });

        window.addEventListener('afterprint', function() {
            document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        });
    </script>
</body>
</html>